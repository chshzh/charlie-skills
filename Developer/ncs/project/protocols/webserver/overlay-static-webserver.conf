# Copyright (c) 2024 Nordic Semiconductor ASA
# SPDX-License-Identifier: LicenseRef-Nordic-5-Clause

#
# Static Web Server Configuration Overlay
# Based on Nordic Thingy91x Suitcase Demo implementation
#
# This overlay enables a full-featured HTTP server with:
# - Static resource serving (HTML, CSS, JS, images, 3D models)
# - Dynamic REST API endpoints
# - WebSocket support for real-time data
# - Gzip compression for efficient bandwidth usage
#

# ============================================================================
# HTTP Server Core
# ============================================================================
CONFIG_HTTP_PARSER=y
CONFIG_HTTP_PARSER_URL=y
CONFIG_HTTP_SERVER=y
CONFIG_HTTP_SERVER_WEBSOCKET=y
CONFIG_HTTP_SERVER_MAX_CLIENTS=10
CONFIG_HTTP_SERVER_STACK_SIZE=8192

# ============================================================================
# Network Requirements
# ============================================================================
CONFIG_NETWORKING=y
CONFIG_NET_SOCKETS=y
CONFIG_NET_TCP=y
CONFIG_NET_IPV4=y

# Increase network buffers for web server load
CONFIG_NET_PKT_RX_COUNT=32
CONFIG_NET_PKT_TX_COUNT=48
CONFIG_NET_BUF_RX_COUNT=32
CONFIG_NET_BUF_TX_COUNT=64

# Socket configuration
CONFIG_NET_SOCKETS_POLL_MAX=10
CONFIG_NET_MAX_CONN=16
CONFIG_NET_MAX_CONTEXTS=16

# ============================================================================
# Static Resource Support
# ============================================================================
# Enable filesystem and compression (if serving from flash)
# Most commonly: embed resources as .gz.inc files via CMake

# ============================================================================
# JSON Support (for REST APIs)
# ============================================================================
CONFIG_JSON_LIBRARY=y

# ============================================================================
# mDNS / DNS-SD (Optional but recommended)
# ============================================================================
# Enables discovery via hostname.local (e.g., thingy91x.local)
CONFIG_MDNS_RESPONDER=y
CONFIG_DNS_SD=y
CONFIG_MDNS_RESPONDER_DNS_SD=y
CONFIG_NET_HOSTNAME_ENABLE=y
CONFIG_NET_HOSTNAME_UNIQUE=n
# CONFIG_NET_HOSTNAME="mydevice"  # Set in prj.conf or overlay

# ============================================================================
# TLS/HTTPS (if serving HTTPS)
# ============================================================================
# Uncomment for HTTPS support
# CONFIG_NET_SOCKETS_SOCKOPT_TLS=y
# CONFIG_NET_SOCKETS_TLS_MAX_CONTEXTS=2
# CONFIG_TLS_CREDENTIALS_BACKEND_VOLATILE=y
# CONFIG_NRF_SECURITY=y
# CONFIG_MBEDTLS=y
# CONFIG_MBEDTLS_TLS_LIBRARY=y
# CONFIG_MBEDTLS_ENABLE_HEAP=y
# CONFIG_MBEDTLS_HEAP_SIZE=81920

# ============================================================================
# Memory Configuration
# ============================================================================
# Adjust heap size based on:
# - Number of simultaneous clients
# - Size of static resources
# - WebSocket connections
CONFIG_HEAP_MEM_POOL_SIZE=90000
CONFIG_HEAP_MEM_POOL_IGNORE_MIN=y

# Increase stacks for HTTP processing
CONFIG_MAIN_STACK_SIZE=2048
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=2048
CONFIG_NET_RX_STACK_SIZE=2048
CONFIG_NET_TX_STACK_SIZE=2048
CONFIG_NET_MGMT_EVENT_STACK_SIZE=8192

# ============================================================================
# Logging (for debugging)
# ============================================================================
CONFIG_LOG=y
# CONFIG_HTTP_SERVER_LOG_LEVEL_DBG=y
# CONFIG_NET_HTTP_LOG_LEVEL_DBG=y

# ============================================================================
# POSIX API (for eventfd in HTTP server)
# ============================================================================
CONFIG_EVENTFD=y
CONFIG_ZVFS_OPEN_MAX=32
CONFIG_ZVFS_EVENTFD_MAX=2
CONFIG_POSIX_API=y
CONFIG_FDTABLE=y

# ============================================================================
# Usage Notes
# ============================================================================
# 1. In CMakeLists.txt, add:
#    - zephyr_linker_section for HTTP service
#    - generate_inc_file_for_target() for each static resource
#
# 2. Create http_resources.c with HTTP_RESOURCE_DEFINE() macros
#
# 3. Set static IP or use DHCP in prj.conf:
#    CONFIG_NET_CONFIG_MY_IPV4_ADDR="192.168.1.99"
#
# 4. Memory requirements:
#    - Flash: ~100KB (base) + static resources
#    - RAM: ~80KB
#    - Heap: 90KB+ (adjust based on load)
#
# 5. Typical combined build:
#    west build -- -DEXTRA_CONF_FILE="wifi-sta.conf;overlay-static-webserver.conf"
